# Phase 4: GitHub Secrets Configuration

**Last Updated**: 2025-10-26
**Prerequisites**: Phase 3 (Server Setup) must be complete

---

## Overview

This phase configures the encrypted secrets that GitHub Actions needs to deploy to your production server. All secrets are encrypted using GitHub's libsodium sealed box and are only available to authorized workflows.

**Time Required**: ~10-15 minutes

---

## Required Secrets Summary

| Secret Name | Description | Where to Get It |
|-------------|-------------|-----------------|
| `PROD_HOST` | Production server hostname/IP | Your server address |
| `PROD_USER` | Deploy user on server | From Phase 3 (usually `deploy`) |
| `PROD_SSH_KEY` | Private SSH key for authentication | From Phase 3 (`~/.ssh/parchmark_deploy`) |
| `GHCR_PULL_TOKEN` | GitHub token to pull images | Generate in this phase |

---

## Step 1: Prepare Secret Values

### 1.1 Get SSH Private Key

**On your local machine**:

```bash
# Display the private key
cat ~/.ssh/parchmark_deploy

# The output should look like:
# -----BEGIN OPENSSH PRIVATE KEY-----
# b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
# ... (many lines) ...
# -----END OPENSSH PRIVATE KEY-----
```

**IMPORTANT**:
- Copy the **entire output** including the BEGIN and END lines
- Do NOT share this key with anyone
- Keep this terminal open for reference

### 1.2 Verify Server Details

You should have these from Phase 3:
- **PROD_HOST**: `notes.engen.tech` (or your server IP like `100.120.107.12`)
- **PROD_USER**: `deploy`

Test connection one more time:
```bash
ssh -i ~/.ssh/parchmark_deploy deploy@notes.engen.tech
# Should connect without password
exit
```

---

## Step 2: Generate GHCR Pull Token

### 2.1 Why We Need a Classic Token

**Important Context** (Validated January 2025):
- ‚ùå **Fine-grained tokens are NOT supported** for GitHub Container Registry (GHCR)
- ‚úÖ **Classic Personal Access Tokens are required** for GHCR authentication
- üìù **Two different tokens in our setup**:
  - `GITHUB_TOKEN` - Auto-generated by GitHub Actions for **pushing** images (secure, automatic)
  - `GHCR_PULL_TOKEN` - Classic PAT needed for production server to **pull** images

**Why this token is needed**:
- Your production server is not a GitHub Actions runner
- It needs credentials to pull private images from GHCR
- Classic PAT is the only supported method for external servers

### 2.2 Create Personal Access Token (Classic)

1. **Go to GitHub Settings**:
   - Click your profile photo (top right)
   - Click "Settings"
   - Scroll down to "Developer settings" (left sidebar, near bottom)

2. **Access Token Settings**:
   - Click "Personal access tokens"
   - Click **"Tokens (classic)"** ‚ö†Ô∏è (NOT "Fine-grained tokens")
   - Click "Generate new token (classic)"

3. **Configure Token**:
   - **Note**: `ParchMark GHCR Pull Token - Production Server`
   - **Expiration**: `90 days` (set calendar reminder to rotate)
   - **Select scopes** (minimum required):
     - ‚úÖ `read:packages` - Download packages from GitHub Container Registry
   - **IMPORTANT**: Do NOT select `write:packages` or `delete:packages` (read-only for security)

4. **Generate and Copy**:
   - Click "Generate token" (bottom of page)
   - **Copy the token immediately** - you won't see it again!
   - It will start with `ghp_` followed by alphanumeric characters
   - Paste it somewhere safe temporarily (you'll add it to GitHub Secrets next)

### 2.3 Token Security Notes

- ‚úÖ This token has **read-only** access to your packages (GHCR)
- ‚úÖ Expires in 90 days for security best practices
- ‚úÖ Only used by production server for pulling images
- ‚ùå Never commit this token to your repository
- üìÖ Set a calendar reminder to rotate before expiration
- üîí Classic tokens are the ONLY supported option for GHCR (as of January 2025)

---

## Step 3: Add Secrets to GitHub Repository

### 3.1 Navigate to Repository Secrets

1. **Go to your repository**: https://github.com/TejGandham/parchmark
2. **Click "Settings"** (tab at top of repository)
3. **Click "Secrets and variables"** (left sidebar under "Security")
4. **Click "Actions"**
5. **You should see "Repository secrets"** section

### 3.2 Add PROD_HOST Secret

1. Click **"New repository secret"**
2. **Name**: `PROD_HOST`
3. **Secret**: `notes.engen.tech` (or your server IP)
4. Click **"Add secret"**

### 3.3 Add PROD_USER Secret

1. Click **"New repository secret"**
2. **Name**: `PROD_USER`
3. **Secret**: `deploy`
4. Click **"Add secret"**

### 3.4 Add PROD_SSH_KEY Secret

1. Click **"New repository secret"**
2. **Name**: `PROD_SSH_KEY`
3. **Secret**: Paste the **entire private key** from Step 1.1
   - Must include `-----BEGIN OPENSSH PRIVATE KEY-----`
   - Must include `-----END OPENSSH PRIVATE KEY-----`
   - Must include all lines in between
   - Should be ~50-60 lines total for ED25519 keys
4. Click **"Add secret"**

**Common Mistakes**:
- ‚ùå Pasting the public key instead of private key
- ‚ùå Missing the BEGIN/END lines
- ‚ùå Adding extra whitespace or line breaks
- ‚úÖ Copy exactly as shown by `cat ~/.ssh/parchmark_deploy`

### 3.5 Add GHCR_PULL_TOKEN Secret

1. Click **"New repository secret"**
2. **Name**: `GHCR_PULL_TOKEN`
3. **Secret**: Paste the GitHub Personal Access Token from Step 2
4. Click **"Add secret"**

### 3.6 Verify All Secrets

You should now see 4 secrets listed:
- `GHCR_PULL_TOKEN`
- `PROD_HOST`
- `PROD_SSH_KEY`
- `PROD_USER`

**Note**: You cannot view secret values after creation (security feature). You can only update or delete them.

---

## Step 4: Configure Production Environment (Optional but Recommended)

This adds a manual approval step before production deployment for extra safety.

### 4.1 Create Production Environment

1. **In repository Settings**, click **"Environments"** (left sidebar)
2. Click **"New environment"**
3. **Name**: `production` (must be exactly this - lowercase, no spaces)
4. Click **"Configure environment"**

### 4.2 Configure Protection Rules

**Required reviewers**:
- ‚úÖ Check "Required reviewers"
- Click "Add reviewers"
- Select yourself (your GitHub username)
- This requires manual approval before deployment

**Wait timer** (optional):
- Can add a delay before deployment (e.g., 5 minutes)
- Recommended: 0 minutes (no delay, just approval)

**Deployment branches**:
- ‚úÖ Select "Selected branches"
- Add rule: `main`
- This ensures only main branch can deploy to production

### 4.3 Save Configuration

1. Click **"Save protection rules"**
2. You should see "production" environment listed
3. It will show "Required reviewers: 1" and "Deployment branches: main"

---

## Step 5: Test Secret Configuration

### 5.1 Test SSH Connection (Manual Verification)

Before running GitHub Actions, verify SSH access manually:

```bash
# Test that GitHub can connect with your key
ssh -i ~/.ssh/parchmark_deploy deploy@notes.engen.tech "echo 'SSH connection successful'"

# Test docker access
ssh -i ~/.ssh/parchmark_deploy deploy@notes.engen.tech "docker ps"

# Test project directory access
ssh -i ~/.ssh/parchmark_deploy deploy@notes.engen.tech "ls -la /home/deploy/parchmark"
```

All commands should succeed without password prompts.

### 5.2 Verify GHCR Token (Optional)

Test the GHCR token can pull images:

```bash
# Replace YOUR_TOKEN with the actual token from Step 2
echo "YOUR_TOKEN" | docker login ghcr.io -u TejGandham --password-stdin

# Test pulling public image (if you have any)
docker pull ghcr.io/tejgandham/parchmark-backend:latest || echo "Image doesn't exist yet (expected)"

# Logout
docker logout ghcr.io
```

**Note**: If no images exist in GHCR yet, this is expected. Phase 5 will build and push the first images.

---

## Step 6: Update SSH Config (Recommended)

For easier manual access to production server, add this to your local SSH config:

**File**: `~/.ssh/config`

```
# ParchMark Production Server
Host parchmark-prod
    HostName notes.engen.tech
    User deploy
    IdentityFile ~/.ssh/parchmark_deploy
    ServerAliveInterval 60
    ServerAliveCountMax 3
```

**Usage**:
```bash
# Instead of: ssh -i ~/.ssh/parchmark_deploy deploy@notes.engen.tech
# You can now use:
ssh parchmark-prod

# Make commands even shorter
ssh parchmark-prod 'docker ps'
```

---

## Phase 4 Checklist

- [x] SSH private key retrieved from local machine
- [x] GHCR token generated with `read:packages` scope
- [x] `PROD_HOST` secret added to GitHub
- [x] `PROD_USER` secret added to GitHub
- [x] `PROD_SSH_KEY` secret added to GitHub (full key with BEGIN/END lines)
- [x] `GHCR_PULL_TOKEN` secret added to GitHub
- [x] All 4 secrets visible in repository settings
- [x] Production environment created (optional but recommended)
- [x] Manual approval configured for production
- [x] Deployment branch restricted to `main`
- [x] SSH connection tested successfully
- [x] Token expiration reminder set (90 days)

---

## Security Best Practices

### Secret Rotation Schedule

| Secret | Rotation Frequency | How to Rotate |
|--------|-------------------|---------------|
| `PROD_SSH_KEY` | Every 90 days | Generate new key, update server + GitHub |
| `GHCR_PULL_TOKEN` | Every 90 days | Generate new token, update GitHub secret |
| `PROD_HOST` | Only when server changes | Update GitHub secret |
| `PROD_USER` | Only when user changes | Update GitHub secret |

### Security Checklist

- ‚úÖ Private key never committed to repository
- ‚úÖ Token has minimum required permissions (read-only)
- ‚úÖ Environment protection enabled (manual approval)
- ‚úÖ Deployment restricted to main branch only
- ‚úÖ Calendar reminders set for token rotation
- ‚úÖ SSH config uses key authentication (no passwords)
- ‚úÖ Server allows only key-based authentication

---

## Troubleshooting

### "Secret not found" in GitHub Actions

**Symptom**: Workflow fails with "Secret PROD_SSH_KEY not found"

**Solution**:
1. Go to Settings ‚Üí Secrets and variables ‚Üí Actions
2. Verify secret name matches exactly (case-sensitive)
3. Ensure secret is in "Repository secrets" not "Environment secrets"

### "Permission denied (publickey)" in GitHub Actions

**Symptom**: SSH connection fails during deployment

**Solutions**:
1. Verify you copied the PRIVATE key (not public key)
2. Ensure entire key including BEGIN/END lines is in secret
3. Test manually: `ssh -i ~/.ssh/parchmark_deploy deploy@notes.engen.tech`
4. Check server authorized_keys file has correct public key

### GHCR Token Authentication Fails

**Symptom**: "unauthorized: authentication required"

**Solutions**:
1. Verify token has `read:packages` scope
2. Check token hasn't expired (90-day limit)
3. Ensure token is for correct GitHub account
4. Generate new token if needed

### Fine-Grained Token Not Working

**Symptom**: "denied: permission_denied: write_package" or authentication failures with fine-grained token

**Solution**: **Fine-grained tokens are NOT supported for GHCR** (validated January 2025)
1. You MUST use a **Personal Access Token (classic)**
2. Fine-grained tokens will fail even with all permissions set
3. GitHub Packages team has confirmed this is a known limitation
4. Follow Step 2.2 to create a classic token instead

**Why this happens**:
- GitHub Container Registry does not support fine-grained tokens
- Only classic PATs work with GHCR authentication
- This is a platform limitation, not a configuration issue

### Environment Protection Not Working

**Symptom**: Deployment runs without approval prompt

**Solutions**:
1. Verify environment name is exactly `production` (lowercase)
2. Check workflow uses: `environment: production`
3. Ensure you're listed as required reviewer
4. Verify deployment branch matches (main)

---

## Next Steps

Once Phase 4 is complete:
- **Phase 5**: Create GitHub Actions workflow (`.github/workflows/deploy.yml`)
- **Phase 6**: Add Makefile deployment targets for convenience

You're ready for Phase 5 when:
- ‚úÖ All 4 secrets are configured in GitHub
- ‚úÖ Production environment is set up with approval
- ‚úÖ SSH connection tested and working
- ‚úÖ GHCR token validated

---

## Additional Resources

- **GitHub Secrets Documentation**: https://docs.github.com/en/actions/security-guides/encrypted-secrets
- **GitHub Environments**: https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment
- **SSH Key Management**: https://docs.github.com/en/authentication/connecting-to-github-with-ssh
- **GHCR Authentication**: https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry

---

**Phase 4 Complete!** üéâ

Your GitHub repository now has all the secrets needed for automated deployment.

Proceed to Phase 5 to create the GitHub Actions workflow.
