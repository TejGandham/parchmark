# Standalone Database Admin Container
# Use this for running migrations and database tasks in any environment
#
# Usage:
#   Interactive mode:  make db-admin
#   Run migrations:    make db-admin-migrate
#   Check status:      make db-admin-status
#
# Prerequisites:
#   - PostgreSQL must be running (via docker-compose.dev.yml or docker-compose.yml)
#   - DATABASE_URL can be overridden for different environments
#
# Network modes:
#   - Default: Uses host.docker.internal to reach PostgreSQL on host (works on macOS/Windows)
#   - Linux: Override DATABASE_URL to use localhost if using network_mode: host
#   - Docker network: Override DATABASE_URL to use container name (e.g., postgres:5432)

services:
  db-admin:
    image: astral/uv:python3.13-bookworm
    container_name: parchmark-db-admin
    stdin_open: true
    tty: true
    working_dir: /app
    volumes:
      - ./backend:/app
    environment:
      # Use host.docker.internal for macOS/Windows/Linux compatibility
      # Override DATABASE_URL for different environments (Docker networks, production)
      - DATABASE_URL=${DATABASE_URL:-postgresql://parchmark_user:parchmark_password@host.docker.internal:5432/parchmark_db}
      # Disable Python bytecode and enable unbuffered output
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    # Enable host.docker.internal on Linux (already works on macOS/Windows)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    entrypoint: ["/bin/bash", "/app/scripts/db-admin-entrypoint.sh"]
